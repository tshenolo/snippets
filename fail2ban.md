# fail2ban Cheatsheet

Fail2ban is an intrusion prevention software framework that protects computer servers from brute-force attacks and other malicious login attempts. It monitors log files for suspicious patterns and uses firewall rules (like iptables or UFW) to ban offending IP addresses.

## Installation

Installation methods vary by distribution.
*   **Debian/Ubuntu**:
    ```bash
    sudo apt update
    sudo apt install fail2ban
    ```
*   **RHEL/CentOS (with EPEL repository)**:
    ```bash
    sudo yum install epel-release
    sudo yum install fail2ban
    # For systems with DNF (e.g., CentOS 8+, Fedora):
    # sudo dnf install fail2ban
    ```
*   **Start and Enable Fail2ban service**:
    ```bash
    sudo systemctl start fail2ban
    sudo systemctl enable fail2ban
    sudo systemctl status fail2ban # Check status
    ```

## Configuration Files

*   **Main Configuration**:
    *   `/etc/fail2ban/fail2ban.conf`: Default global configuration. **Do not edit this file directly.**
    *   `/etc/fail2ban/fail2ban.local`: Local overrides for `fail2ban.conf`. Create this file for your customizations.
*   **Jail Configuration**:
    *   `/etc/fail2ban/jail.conf`: Default jail configurations (includes pre-defined jails for common services). **Do not edit this file directly.**
    *   `/etc/fail2ban/jail.local`: Local overrides for `jail.conf`. This is the primary file for enabling and customizing jails.
    *   `/etc/fail2ban/jail.d/*.conf` or `*.local`: Directory for multiple jail configuration files (can override `jail.conf` and `jail.local`). Good for organizing.
*   **Filter Definitions**:
    *   `/etc/fail2ban/filter.d/*.conf`: Contains regular expressions (`failregex`, `ignoreregex`) used to detect malicious attempts in log files.
*   **Action Definitions**:
    *   `/etc/fail2ban/action.d/*.conf`: Defines the actions to take when a ban is triggered (e.g., iptables rules, UFW rules, sending emails).

**Key Principle**: Create `.local` files for your customizations. Fail2ban reads `.conf` files first, then `.local` files, with settings in `.local` overriding those in `.conf`.

## Basic `jail.local` Configuration

Create `/etc/fail2ban/jail.local` if it doesn't exist.

```ini
# /etc/fail2ban/jail.local

[DEFAULT]
# Default settings applied to all jails unless overridden in a specific jail section.

# IPs to ignore (whitelist). Can be IP addresses, CIDR masks, or DNS hosts.
# Separate multiple entries with spaces or commas.
ignoreip = 127.0.0.1/8 ::1 192.168.1.0/24 my.trusted.domain.com

# Default ban time in seconds.
# Use 's' for seconds, 'm' for minutes, 'h' for hours, 'd' for days, 'w' for weeks.
# -1 means permanent ban.
bantime  = 10m

# Time window (in seconds) during which 'maxretry' attempts trigger a ban.
findtime = 10m

# Number of failures before an IP is banned.
maxretry = 5

# Backend used to track failures (auto, pyinotify, gamin, polling). 'auto' is usually fine.
# backend = auto

# Default banning action. %(action_)s uses the default action defined for the system (e.g., iptables-multiport).
# Common actions:
# action_ = %(banaction)s[name=%(__name__)s, port="%(port)s", protocol="%(protocol)s", chain="%(chain)s"]
# action_mw = %(action_)s
#             %(mta)s-whois[name=%(__name__)s, dest="%(destemail)s", protocol="%(protocol)s", chain="%(chain)s", sendername="Fail2Ban"]
# action_mwl = %(action_mw)s
#              %(mta)s-whois-lines[name=%(__name__)s, dest="%(destemail)s", logpath="%(logpath)s", chain="%(chain)s"]
# banaction: The actual command to ban/unban an IP (e.g., iptables-multiport, ufw, nftables).
# banaction_allports: Bans all ports for an IP.
# destemail: Email address for notifications.
# sender: Sender email address.
# mta: Mail Transfer Agent (e.g., sendmail, mail).

# Example: Using UFW for banning
# banaction = ufw
# Example: Custom action for iptables
# action = iptables-multiport[name=SSH, port=ssh, protocol=tcp]

# --- SSH Jail ---
[sshd]
enabled = true
port    = ssh # Can be a port number or service name from /etc/services
# filter  = sshd # Name of the filter file in /etc/fail2ban/filter.d/sshd.conf
# logpath = /var/log/auth.log # For Debian/Ubuntu; /var/log/secure for RHEL/CentOS
# maxretry = 3
# bantime = 1h

# --- Apache Basic Auth Jail ---
[apache-auth]
enabled = false # Example: disabled by default
port    = http,https
# filter  = apache-auth
# logpath = /var/log/apache2/error.log # Adjust for your Apache error log path
# maxretry = 6

# --- Apache Bad Bots Jail ---
[apache-badbots]
enabled   = false
# port      = http,https
# filter    = apache-badbots
# logpath   = /var/log/apache2/access.log # Adjust for your Apache access log path
# maxretry  = 2
# bantime   = 48h

# --- Nginx HTTP Auth Jail ---
[nginx-http-auth]
enabled = false
# filter  = nginx-http-auth
# logpath = /var/log/nginx/error.log
# port    = http,https

# --- Nginx Bad Bots ---
[nginx-badbots]
enabled = false
# logpath = /var/log/nginx/access.log
# maxretry = 2
# bantime = 48h

# --- vsftpd Jail ---
[vsftpd]
enabled = false
# port    = ftp,ftp-data,ftps,ftps-data
# filter  = vsftpd
# logpath = /var/log/vsftpd.log
# maxretry = 5
# bantime = 1d

# Add more jails as needed...
```
**After making changes to `.local` files, always reload or restart Fail2ban:**
```bash
sudo systemctl reload fail2ban
# or
# sudo systemctl restart fail2ban
```

## `fail2ban-client` Commands

This command-line tool is used to control and query the Fail2ban server.

*   **Check Fail2ban server status**:
    ```bash
    sudo fail2ban-client status
    ```
*   **Check status of a specific jail**:
    ```bash
    sudo fail2ban-client status <jail_name>
    # Example:
    # sudo fail2ban-client status sshd
    ```
    This will show currently failed IPs and currently banned IPs for that jail.
*   **Manually ban an IP address in a specific jail**:
    ```bash
    sudo fail2ban-client set <jail_name> banip <IP_ADDRESS>
    # Example:
    # sudo fail2ban-client set sshd banip 192.0.2.100
    ```
*   **Manually unban an IP address from a specific jail**:
    ```bash
    sudo fail2ban-client set <jail_name> unbanip <IP_ADDRESS>
    # Example:
    # sudo fail2ban-client set sshd unbanip 192.0.2.100
    ```
*   **Reload Fail2ban configuration** (applies changes from config files):
    ```bash
    sudo fail2ban-client reload
    ```
*   **Start a jail**:
    ```bash
    sudo fail2ban-client start <jail_name>
    ```
*   **Stop a jail**:
    ```bash
    sudo fail2ban-client stop <jail_name>
    ```
*   **Get value of a configuration option for a jail**:
    ```bash
    sudo fail2ban-client get <jail_name> <option_name>
    # Example:
    # sudo fail2ban-client get sshd bantime
    # sudo fail2ban-client get sshd logpath
    ```
*   **Set value of a configuration option for a jail (runtime, not persistent)**:
    ```bash
    sudo fail2ban-client set <jail_name> <option_name> <value>
    # Example (temporarily change bantime for sshd):
    # sudo fail2ban-client set sshd bantime 3600
    ```
*   **Ping the server** (check if it's running):
    ```bash
    sudo fail2ban-client ping # Expected output: Server replied: pong
    ```

## Testing Filters (Regular Expressions)

Use `fail2ban-regex` to test if your filter's regular expressions correctly match log lines.

*   **Test a log file against a filter**:
    ```bash
    fail2ban-regex /path/to/logfile.log /etc/fail2ban/filter.d/myfilter.conf
    # Example for SSH:
    # fail2ban-regex /var/log/auth.log /etc/fail2ban/filter.d/sshd.conf
    ```
*   **Test a single log line against a filter**:
    ```bash
    fail2ban-regex "Dec 10 10:00:00 server sshd[1234]: Failed password for invalid user jsmith from 192.0.2.5 port 12345 ssh2" /etc/fail2ban/filter.d/sshd.conf
    ```
    The output will show:
    *   Number of lines matched by `failregex`.
    *   Number of lines ignored by `ignoreregex`.
    *   The actual IP addresses that would be matched.

## Customizing Filters (`/etc/fail2ban/filter.d/`)

If a pre-defined filter doesn't meet your needs, you can create a custom one or override parts of an existing one.

*   **Example: `my-custom-app.conf`**
    ```ini
    # /etc/fail2ban/filter.d/my-custom-app.conf
    [INCLUDES]
    # before = common.conf # Optional: include common definitions

    [Definition]
    # failregex: Regular expression to match failed login attempts.
    #            <HOST> is a special tag that matches an IP address or hostname.
    failregex = ^.*Failed login for user '.*' from <HOST>.*$
                ^.*Connection from <HOST> rejected by TCP Wrappers.*$

    # ignoreregex: Regular expression for lines to ignore (e.g., successful logins).
    # ignoreregex = ^.*Accepted publickey for .* from <HOST>.*$

    # datepattern: Defines how to extract the date/time from log lines.
    #              Common patterns: {^LN-BEG}, %%Y-%%m-%%d %%H:%%M:%%S, etc.
    #              Default is often sufficient if logs are standard syslog format.
    # datepattern = ^%%b %%d %%H:%%M:%%S
    ```
    Then, in your `jail.local`:
    ```ini
    [my-custom-app-jail]
    enabled = true
    port = 12345 # Port your custom app listens on
    filter = my-custom-app # Name of the filter file (without .conf)
    logpath = /var/log/my-custom-app/error.log
    maxretry = 3
    bantime = 2h
    ```

## Log Rotation

Ensure Fail2ban can still read logs after log rotation. Most modern Fail2ban versions handle this well, but if you encounter issues, check your logrotate configuration and Fail2ban's `backend` setting.

## Common Issues

*   **Incorrect `logpath`**: Ensure the `logpath` in your jail configuration points to the correct log file for the service.
*   **Incorrect `filter` or `failregex`**: Use `fail2ban-regex` to test your filters.
*   **Firewall issues**: Make sure your `banaction` (e.g., `iptables-multiport`, `ufw`) is correctly configured and that your firewall is running. Sometimes, other firewall tools can interfere.
*   **Permissions**: Fail2ban needs permission to read log files.
*   **Time synchronization**: Large time differences between the server and log entries can affect `findtime`. Ensure NTP is configured.

This detailed `fail2ban.md` should be very helpful. I'll proceed with `azure_cli.md`.The `fail2ban.md` cheatsheet has been enhanced with detailed explanations of configuration files, `fail2ban-client` commands, filter testing, and examples for custom jails.

Next, I will work on `azure_cli.md`, adding more specific command examples for managing various Azure resources.
